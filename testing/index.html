<!DOCTYPE html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<link href='http://fonts.googleapis.com/css?family=Montserrat|Open+Sans:400,600' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="scotchit.css">
		<link rel="stylesheet" href="//cdn.datatables.net/1.10.5/css/jquery.dataTables.min.css">
		<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
		<script src="/papaparse/papaparse.min.js"></script>
		<script src="http://code.highcharts.com/highcharts.js" type="text/javascript"></script>
		<script type="text/javascript" src="https://www.google.com/jsapi"></script>
		<script type="text/javascript" src="//cdn.datatables.net/1.10.5/js/jquery.dataTables.min.js"></script>
		<script type="text/javascript">
			google.load("visualization", "1", {packages:["table"]});
			$(function() {

				var selectedPoint;

				var Whisky = function(name, rating, cloud, price, region){
					this.Name = name;
					this.Rating = rating;
					this.WordCloud = cloud;
					this.Price = price;
					this.Region = region;
				};

				var whiskysList = [
					["Macallan Sherry Cask Strength", "macallancaskstrength", "http://i.imgur.com/8buv3qa.png", "Speyside"],
					["Aberlour A'bunadh", "aberlourabunadh", "http://i.imgur.com/W1sgU.png?1", "Speyside"],
					["Macallan 18 Sherry", "macallan18sherry", "http://i.imgur.com/NfrDM4S.png", "Speyside"],
					["Macallan 12 Sherry", "macallan12sherry", "http://i.imgur.com/qnKAhT6.png?1", "Speyside"],
					["Aberlour 12 Non Chill Filtered", "aberlour12ncf", "http://i.imgur.com/RTKwnvA.png", "Speyside"],
					["Glenfarclas 17", "glenfarclas17", "http://i.imgur.com/tLhtq8Z.png", "Highland"],
					["Glendronach 12", "glendronach12", "http://i.imgur.com/M6GwSuN.png", "Highland"],
					["Glenfarclas 12", "glenfarclas12", "http://i.imgur.com/fTd6367.png", "Highland"],
					["Glenmorangie Quinta Ruban", "glenmorangiequinta", "http://i.imgur.com/X2Wo7Zi.png", "Highland"],
					["Auchentoshan Three Wood", "auchentoshan3wood", "http://i.imgur.com/zYSBlpF.png", "Lowland"],
					["Glenlivet 18", "glenlivet18", "http://i.imgur.com/STJJ2HH.png", "Speyside"],
					["Glengoyne 10", "glengoyne10", "http://i.imgur.com/G5WUiPY.png", "Highland"],
					["Balvenie 14 Caribbean Cask", "balveniecaribbean", "http://i.imgur.com/n7gaL3V.png", "Speyside"],
					["Glenmorangie Lasanta", "glenmorangielasanta", "http://i.imgur.com/E3pziD3.png", "Highland"],
					["Aberlour 12 Double Cask Matured", "aberlour12dc", "http://i.imgur.com/hCnhVaw.png", "Speyside"],
					["Glenfiddich 15", "glenfiddich15", "http://i.imgur.com/BYQYIKb.png", "Speyside"],
					["Tomatin 12", "tomatin12", "http://i.imgur.com/8W71GUq.png", "Highland"],
					["Pig's Nose", "pigsnose", "http://i.imgur.com/LBlytiu.png", "Other"],
					["Glenlivet 16 Nadurra", "glenlivetnadurra", "http://i.imgur.com/dC7da3e.png", "Speyside"],
					["Highland Park 15", "highlandpark15", "http://i.imgur.com/gGBX9BZ.png", "Island"],
					["Oban 18", "oban18", "http://i.imgur.com/rcrrhpy.png", "Highland"],
					["Glenlivet 15 French Oak Reserve", "glenlivet15", "http://i.imgur.com/FuAOies.png", "Speyside"],
					["Glenfiddich 12", "glenfiddich12", "http://i.imgur.com/gMnClQy.jpg", "Speyside"],
					["Springbank 10", "springbank10", "http://i.imgur.com/fUH3tIz.jpg", "Campbeltown"],
					["Oban 14", "oban14", "http://i.imgur.com/1lJRxYJ.png", "Highland"],
					["Old Pulteney 12", "oldpulteney12", "http://i.imgur.com/jgisRPG.png?1", "Highland"],
					["Glenlivet 12", "glenlivet12", "http://i.imgur.com/ZYL6l8h.png?1", "Speyside"],
					["Glenmorangie Nectar D'Or", "glenmorangienectar", "http://i.imgur.com/scWXCyB.png", "Highland"],
					["Deanston 12", "deanston12", "http://i.imgur.com/w6dYRdD.png?1", "Highland"],
					["Scapa 16", "scapa16", "http://i.imgur.com/1BCRecf.png", "Island"],
					["Macallan 17 Fine Oak", "macallan17fo", "http://i.imgur.com/EMxOOuL.png", "Speyside"],
					["Macallan 10 Fine Oak", "macallan10fo", "http://i.imgur.com/1FIg3Sa.png", "Speyside"],
					["Balvenie 12 Doublewood", "balvenie12dw", "http://i.imgur.com/XQ0cCEe.png", "Speyside"],
					["Glenmorangie Original 10", "glenmorangie10o", "http://i.imgur.com/hODgTl0.png", "Highland"],
					["Auchentoshan Classic", "auchentoshanclassic", "http://i.imgur.com/xmAjLUP.png", "Lowland"],
					["Glenkinchie 12", "glenkinchie12", "http://i.imgur.com/yq8VrCe.png", "Lowland"],
					["Dalwhinnie 15", "dalwhinnie15", "http://i.imgur.com/C1EySTj.png?1", "Speyside"],
					["Tobermory 10", "tobermory10", "http://i.imgur.com/RKnpX0a.jpg", "Island"],
					["Bruichladdich Rocks", "bruichladdichrocks", "http://i.imgur.com/2Xm30Io.png", "Islay"],
					["Ledaig 10", "ledaig10", "http://i.imgur.com/3B8CqOV.png", "Island"],
					["Bruichladdich The Laddie Ten", "bruichladdichladdie", "http://i.imgur.com/QQuIC5w.png", "Islay"],
					["Glenfiddich 18", "glenfiddich18", "http://i.imgur.com/2N9enRW.png", "Speyside"],
					["Cragganmore 12", "cragganmore12", "http://i.imgur.com/NRAm7tJ.png?1", "Speyside"],
					["Highland Park 12", "highlandpark12", "http://i.imgur.com/Sz3a1nq.png?1", "Island"],
					["Johnnie Walker Black Label", "johnniewalkerblack", "http://i.imgur.com/Igs7mQN.png", "Other"],
					["Bowmore 12", "bowmore12", "http://i.imgur.com/0yTUlka.png", "Islay"],
					["Bruichladdich Port Charlotte", "bruichladdichpc", "http://i.imgur.com/qLqoIrQ.png", "Islay"],
					["Bruichladdich Octomore", "bruichladdichoct", "http://i.imgur.com/HadfcBu.png", "Islay"],
					["Kilchoman Peated", "kilchomanpeated", "http://i.imgur.com/NRmufzm.png", "Islay"],
					["Ardbeg 10", "ardbeg10", "http://i.imgur.com/rMP5opn.png", "Islay"],
					["Black Bottle", "blackbottle", "http://i.imgur.com/geyKEvv.png", "Other"],
					["Caol Ila 12", "caolila12", "http://i.imgur.com/wrdg7hW.png", "Islay"],
					["Laphroaig 10 Cask Strength", "laphroaig10cs", "http://i.imgur.com/cJqVlgA.png", "Islay"],
					["Laphroaig 10", "laphroaig10", "http://i.imgur.com/nR0P5dA.png", "Islay"],
					["Smokehead", "smokehead", "http://i.imgur.com/f2ugqKc.png", "Islay"],
					["Ardmore Traditional Cask Peated", "ardmoretradpeated", "http://i.imgur.com/2Ds7rTC.png", "Speyside"],
					["Laphroaig 18", "laphroaig18", "http://i.imgur.com/1qNqH5L.png", "Islay"],
					["Laphroaig Quarter Cask", "laphroaigqc", "http://i.imgur.com/7O4wdij.png", "Islay"],
					["Talisker 10", "talisker10", "http://i.imgur.com/3UWhc99.png", "Island"],
					["Balvenie 17 Peated Cask", "balveniepeated", "http://i.imgur.com/9MuFHX2.png", "Speyside"],
					["Benromach Peat Smoke", "benromachpeatsmoke", "http://i.imgur.com/Rp7ott3.png", "Speyside"],
					["Ardbeg Corryvreckan", "ardbegcorryvreckan", "http://i.imgur.com/NpMjA3u.png", "Islay"],
					["Lagavulin 12", "lagavulin12", "http://i.imgur.com/ON77byY.png", "Islay"],
					["Talisker Distiller's Edition", "taliskerDE", "http://i.imgur.com/aZjBqrj.png", "Island"],
					["Highland Park 18", "highlandpark18", "http://i.imgur.com/fhMbjkC.png", "Island"],
					["Bunnahabhain 12", "bunnahabhain12", "http://i.imgur.com/N8VaZKJ.png?1", "Islay"],
					["Highland Park 25", "highlandpark25", "http://i.imgur.com/8SEmttO.png", "Island"],
					["Lagavulin 16", "lagavulin16", "http://i.imgur.com/bPpXGLU.png", "Islay"],
					["Lagavulin Distiller's Edition", "lagavulinDE", "http://i.imgur.com/n44l4fp.png", "Islay"],
					["Bunnahabhain 18", "bunnahabhain18", "http://i.imgur.com/vcHX5tz.png", "Islay"],
					["Laphroaig Triplewood", "laphroaigtriplewood", "http://i.imgur.com/ELlhae7.png", "Islay"],
					["Ardbeg Uigeadail", "ardbeguigeadail", "http://i.imgur.com/AuquffD.png?1", "Islay"],
					["Bowmore 15 Darkest", "bowmoredarkest", "http://i.imgur.com/P5WN3vq.png", "Islay"],
					["Balvenie 15 Single Barrel", "balvenie15sc", "http://i.imgur.com/Z50atlq.png", "Speyside"],
					["Balvenie 21 Portwood", "balvenie21pw", "http://i.imgur.com/4aDhH96.png", "Speyside"],
					["Dalmore 12", "dalmore12", "http://i.imgur.com/aZbrApI.png", "Highland"],
					["Jura Superstition", "jurasuperstition", "http://i.imgur.com/n88jJZj.png", "Island"],
					["Chivas Regal 12", "chivasregal", "http://i.imgur.com/zV96To0.png", "Other"]
				];

				var scotchDB = '/scotchfile.csv';
				Papa.parse(scotchDB, {
					download: true,
					worker: true,
					header: true,
					complete: function(results) {
						processResults(results);
					}
				});

				function processResults(results) {
					$.each(whiskysList, function(name,variable) {
						var regex = new RegExp(variable[0], "i");
						var tempVar = results.data.map(function(i) {
							if (i["Whisky Name"].match(regex)) {
								return i;
							}
						});
						tempVar = $.grep(tempVar, function(n){return(n)});
						window[variable[1]] = new Whisky(variable[0], averageRating(tempVar), variable[2], getPrice(tempVar), variable[3]);
						$("#movable").append("<p class='scotch " + variable[1] + "'>" + window[variable[1]].Name + "</p>");
					});
					$("#movable p").each(function(index,value) {
						if ( parseFloat($("." + $(this).attr('class').split(' ')[1]).css('left')) <= '450' ) {
							$(this).addClass('w');
						}
					});
					chartInit();
				}

				function averageRating(data) {
					var total = 0;
					var count = 0;
					$.each(data, function(index, value) {
						if (!isNaN(value["Rating"]) && value["Rating"] != "") {
							total += parseFloat(value["Rating"]);
							count++;
						}
					})
					if (total != 0)
						return Math.round(total / count);
					else
						return 0;
				}

				function getPrice(data) {
					var total = 0;
					var count = 0;
					$.each(data, function(index, value) {
						if (value["Price"].indexOf('$') != -1 && !value["Price"].match(/\./) && !value["Price"].match(/[a-z]/i) && !value["Price"].match(/\(/) && value["Price"].indexOf("Â£") == -1 ) {
							total += parseFloat(value["Price"].replace(/\./g, '').replace(/,/g,'.').replace(/[^\d\.]/g,''));
							count++;
						}
					});
					if (total != 0)
						return Math.round(total / count);
					else
						return 0;
				}

				//Chart initialization------------------------------------

				function chartInit() {
					var highlandList = new Array();
					var speysideList = new Array();
					var islandList = new Array();
					var islayList = new Array();
					var otherList = new Array();
					var lowlandList = new Array();
					var campbeltownList = new Array();
					var excluded = new Array();
					$(whiskysList).each(function(key,value) {
						if (window[value[1]].Rating == 0 || window[value[1]].Price == 0)
							excluded.push(window[value[1]].Name);
						else {
							switch(window[value[1]].Region) {
								case 'Highland':
									highlandList.push({'x':window[value[1]].Price, 'y':window[value[1]].Rating, 'name':window[value[1]].Name});
									break;
								case 'Speyside':
									speysideList.push({'x':window[value[1]].Price, 'y':window[value[1]].Rating, 'name':window[value[1]].Name});
									break;
								case 'Island':
									islandList.push({'x':window[value[1]].Price, 'y':window[value[1]].Rating, 'name':window[value[1]].Name});
									break;
								case 'Islay':
									islayList.push({'x':window[value[1]].Price, 'y':window[value[1]].Rating, 'name':window[value[1]].Name});
									break;
								case 'Other':
									otherList.push({'x':window[value[1]].Price, 'y':window[value[1]].Rating, 'name':window[value[1]].Name});
									break;
								case 'Lowland':
									lowlandList.push({'x':window[value[1]].Price, 'y':window[value[1]].Rating, 'name':window[value[1]].Name});
									break;
								case 'Campbeltown':
									campbeltownList.push({'x':window[value[1]].Price, 'y':window[value[1]].Rating, 'name':window[value[1]].Name});
									break;
							}
						}
							
					});

					$("#priceChart").highcharts({
						chart: {
							type:'scatter',
							height: 900,
							width: 1035
						},
						title: {
							text: ''
						},
						xAxis: {
							title: {
								text: 'Price (USD)'
							},
							min: 0
						},
						yAxis: {
							title: {
								text: 'Rating'
							}
						},
						tooltip: {
							formatter: function() {
								var index = this.series.index;
								return "<b>" + this.key + "</b><br>Price: $" + this.x + "<br>Rating: " + this.y + "<br>";
							}
						},
						plotOptions: {
							series: {
								stickyTracking: false,
								allowPointSelect: true,
								marker: {
									states: {
										select: {
											enabled: true,
											radius: 6,
											fillColor: 'black'
										}
									},
									symbol: 'circle'
								},
								point: {
									events: {
										click: function(event) {
											if (!event.point.selected) {
												selectedPoint = [event.point.series.index, event.point.index];
												$('#moreinfo').css('display', 'block');
												$('#info').empty();
												$(whiskysList).each(function(key,value) {
													if (window[value[1]].Name === event.currentTarget.name) {
														$("#info").html("<h2>" + window[value[1]].Name + "</h2>" + "<p>Average Rating: <span class='rating'>" + window[value[1]].Rating + "</span><p class='getReviews'>Scotchit Reviews</p><p class='showOnMap'>Show on Malt Map</p>Word Cloud (click to enlarge): <br><a href='" + window[value[1]].WordCloud + "' target='_blank'><img src='" + window[value[1]].WordCloud + "' class='wordcloud'></a>");
													}
												});
											} else {
												$("#moreinfo").hide();
											}
										}
									}
								}
							}
						},
						series: [{
							name: "Highland",
							data: highlandList
						}, {
							name: "Speyside",
							data: speysideList
						}, {
							name: "Island",
							data: islandList
						}, {
							name: "Islay",
							data: islayList
						}, {
							name: "Other",
							data: otherList
						}, {
							name: "Lowland",
							data: lowlandList
						}, {
							name: "Campbeltown",
							data: campbeltownList
						}]
					});

					console.log("The following are excluded on the Price chart, because the money and/or rating value are 0:");
					$(excluded).each(function(key,value) {
						console.log(value);
					});
				}

				function updateChart(region) {
					var chart = $("#priceChart").highcharts();
					var series = chart.series;
					$(series).each(function(key,value) {
						if (value.name == region) {
							if (value.visible) {
								value.hide();
							} else {
								value.show();
							}
						}
					})
				}

				//Make table of whisky reviews
				function makeTable(list) {
					var data = new Array();
					for (var i = 0; i < list.length; i++) {
						data.push([
							list[i]['Whisky Name'] != '' ? list[i]['Whisky Name'] : '', 
							list[i]['Reviewer Username'] != '' ? list[i]['Reviewer Username'] : '', 
							list[i]['Link To reddit Review'] != '' ? "<a target='_blank' href='" + list[i]['Link To reddit Review'] + "'>" + list[i]['Link To reddit Review'] + "</a>" : '',
							list[i]['Rating'] != '' ? list[i]['Rating'] : '', 
							list[i]['Region'] != '' ? list[i]['Region'] : '', 
							list[i]['Price'] != '' ? list[i]['Price'] : '', 
							list[i]['Date'] != '' ? list[i]['Date'] : ''
						]);
					};
					$("#whiskyReviews").dataTable({
						'data': data,
						'bDeferRender': true,
						'columns': [
							{'title': 'Whisky Name'},
							{'title': 'Reviewer Username'},
							{'title': 'Link To reddit Review'},
							{'title': 'Rating'},
							{'title': 'Region'},
							{'title': 'Price'},
							{'title': 'Date'}
						]
					});
					$("#reviewList, #backgroundFade").show();
				}

				//UI interactions-----------------------------------------

				$("#movable").on('click', "p", function() {
					$(".scotch").css('text-decoration', 'none').css('font-size', '10px');
					$("#info").empty();
					$('#moreinfo').css('display', 'block');
					var t = window[$(this).attr('class').split(' ')[1]];
					$("#info").html("<h2>" + t.Name + "</h2>" + "<p>Average Rating: <span class='rating'>" + t.Rating + "</span><p class='getReviews'>Scotchit Reviews</p><p class='showOnMap'>Show on Ratings vs Price Chart</p>Word Cloud (click to enlarge): <br><a href='" + t.WordCloud + "' target='_blank'><img src='" + t.WordCloud + "' class='wordcloud'></a>");
				});

				$('#ratinglimit').submit(function(e) {
					e.preventDefault();
					var low = $('#lowerrange').val();
					var	high = $('#upperrange').val();
					if (low == '') { low = 0 };
					if (high == '') { high = 100 };
					$(whiskysList).each(function(key, value) {
						if(window[value[1]].Rating > high || window[value[1]].Rating < low) {
							$("#movable p." + value[1]).hide();
						} else {
							$("#movable p." + value[1]).show();
						}
					});
				});
				$('input:reset').on('click', function(e) {
					$('.scotch').css('display', 'block');
				});

				$('#close').on('click', function() {
					$('#moreinfo').css('display', 'none');
					$(".scotch").css('text-decoration', 'none').css('font-size', '10px');
					if (selectedPoint != undefined)
						$("#priceChart").highcharts().series[selectedPoint[0]].points[selectedPoint[1]].select(false,false);
				});

				$("#pricevrating").on('click', function() {
					$('#moreinfo').hide();
					if ($("#priceChart").is(":visible")) {
						$("#priceChart").css('display', 'none');
						$("#map").css('display', 'inline-block');
						$(".scotch").css("text-decoration", "none").css('font-size', '10px');
						$(this).prop('value', "Show Price vs Rating Chart");
						$(".showOnMap").html("Show on Ratings vs Price Chart<br>");
						$("#ratinglimit > input").prop("disabled", false);
						if (selectedPoint != undefined)
							$("#priceChart").highcharts().series[selectedPoint[0]].points[selectedPoint[1]].select(false,false);
					}
					else {
						$("#priceChart").css('display', 'inline-block');
						$("#map").css('display', 'none');
						$(".showOnMap").html("Show on Malt Map<br>");
						$(this).prop('value', "Show Malt Map");
						$("#ratinglimit > input").prop("disabled", true);
					}
				});

				$("#info").on('click', '.showOnMap', function(e) {
					e.preventDefault();
					var clicked = $(this).parent().find("h2").text();
					if ($("#map").is(":visible")) {
						$("#priceChart").css('display', 'inline-block');
						$("#map").css('display', 'none');
						$("#pricevrating").prop('value', "Show Malt Map");
						$(".showOnMap").html("Show on Malt Map<br>");
						$("#ratinglimit > input").prop("disabled", true);

						var chart = $("#priceChart").highcharts();
						$(whiskysList).each(function(key,value) {
							if (value[0] == clicked) {
								for (var i=0; i<chart.series.length; i++) {
									if (chart.series[i].name == value[3]) {
										for(var j=0; j<chart.series[i].data.length; j++) {
											if (chart.series[i].data[j].name == clicked)
												chart.series[i].data[j].select();
										}
									}
								}
							}
						});				
					} else {
						$("#priceChart").css('display', 'none');
						$("#map").css('display', 'inline-block');

						$("#pricevrating").prop('value', "Show Price vs Rating Chart");
						$(".showOnMap").html("Show on Ratings vs Price Chart<br>");
						$("#ratinglimit > input").prop("disabled", false);
						$(".scotch").css("text-decoration", "none").css('font-size', '10px');
						$(whiskysList).each(function(key,value) {
							if (window[value[1]].Name === clicked) {
								$("." + value[1]).css("text-decoration", "underline").css('font-size', '11px');
							}
						});
					}
				});

				$(".regionToggle").change(function() {
					var toggled = $(this);
					if ($(this).is(":checked")) {
						$(whiskysList).each(function(key, value) {
							if(window[value[1]].Region == toggled.val()) {
								$("#movable p." + value[1]).show();
							}
						});
					} else {
						$(whiskysList).each(function(key, value) {
							if(window[value[1]].Region == toggled.val()) {
								$("#movable p." + value[1]).hide();
							}
						});
					}
					updateChart(toggled.val());
				});

				$("#info").on('click', '.getReviews', function() {
					var clicked = $(this).parent().find("h2").text();
					Papa.parse(scotchDB, {
						download: true,
						worker: true,
						header: true,
						complete: function(results) {
							var regex = new RegExp(clicked, "i");
							var tempVar = results.data.map(function(i) {
								if (i["Whisky Name"].match(regex)) {
									return i;
								}
							});
							tempVar = $.grep(tempVar, function(n){return(n)});
							makeTable(tempVar);
						}
					});
				});

				$("#backgroundFade").on('click', function() {
					$(this).hide();
					$("#reviewList").hide();
					$("#whiskyReviews").dataTable().fnDestroy();
				});

				$(document).keyup(function(e) {
					if (e.keyCode == 27) {
						if ($("#backgroundFade").is(":visible")){
							$("#backgroundFade, #reviewList").hide();
							$("#whiskyReviews").dataTable().fnDestroy();
						}
					}
				})
			});
		</script>
	</head>
	<body>
		<div id="container">
			<div id="map">
				<div id="movable"></div>
			</div>
			<div id="priceChart"></div>
			<div id="sidebar">
				<form id="ratinglimit" action="#">
					Show whiskys with ratings:<br>
					<input type="text" id="lowerrange" value="1"> - <input type="text" id="upperrange" value="100">
					<br>
					<input type="submit" value="Apply"><input type="reset" text="Reset">
				</form>
				<div id="regionSelect">
					<p>Regions</p>
					<label><input type="checkbox" class="regionToggle" value="Highland" checked>Highland</label><label><input type="checkbox" class="regionToggle" value="Lowland" checked>Lowland</label><br>
					<label><input type="checkbox" class="regionToggle" value="Speyside" checked>Speyside</label><label><input type="checkbox" class="regionToggle" value="Other" checked>Other</label><br>
					<label><input type="checkbox" class="regionToggle" value="Island" checked>Island</label><label><input type="checkbox" class="regionToggle" value="Islay" checked>Islay</label><br>
					<label><input type="checkbox" class="regionToggle" value="Campbeltown" checked>Campbeltown</label>
				</div>
				<input type="button" value="Show Price vs Rating Chart" id="pricevrating" />
				<!-- Begin Section for "More Information" area -->
				<div id="moreinfo">
					<p id="close">Close</p>
					<div id="info"></div>
				</div>
			</div>
		</div>
		<div id="reviewList"><table id="whiskyReviews"></table></div>
		<div id="backgroundFade"></div>
	</body>
</html>